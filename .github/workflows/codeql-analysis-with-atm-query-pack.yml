name: "CodeQL + ATM analysis"

on:
  workflow_dispatch:

jobs:
  CodeQL-Build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Initialize CodeQL
        id: codeql-init
        uses: github/codeql-action/init@v1
        with:
          tools: https://github.com/dsp-testing/codeql-cli-nightlies/releases/download/codeql-bundle-20211126/codeql-bundle-linux64.tar.gz
          languages: javascript
          db-location: '${{ github.workspace }}/codeql-database'

      - name: Extract CodeQL database
        uses: github/codeql-action/analyze@v1
        with:
          cleanup-level: none

      - name: Install ATM query pack
        env:
          CODEQL_PATH: ${{ steps.codeql-init.outputs.codeql-path }}
        run: |
          ${CODEQL_PATH} pack download codeql/javascript-experimental-atm-queries

      - name: Run ATM queries
        env:
          CODEQL_PATH: ${{ steps.codeql-init.outputs.codeql-path }}
        run: |
          set -exu

          db='${{ github.workspace }}/codeql-database/javascript'

          ${CODEQL_PATH} database analyze \
            --threads=1 \
            --ram=12000 \
            --insecurely-load-models-from-packs \
            --insecurely-execute-ml-model-checksums b4420b8ea7706c9ee3b8f6066c00085c3331edf19efe7fe8d40bb16025ffff78 \
            --rerun \
            --format sarif-latest \
            --output results.sarif.json \
            --additional-packs ~/.codeql \
            -- ${db} javascript-atm-code-scanning.qls

      - name: Upload Adaptive Threat Modeling results
        uses: actions/upload-artifact@v2
        with:
          name: results.sarif.json
          path: results.sarif.json



